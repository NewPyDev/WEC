{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}Create Order{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-3">Create New Order</h1>
            
            <form method="post" id="orderForm">
                {% csrf_token %}
                
                <!-- Client Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Client Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label for="{{ form.client.id_for_label }}">Existing Client</label>
                            {{ form.client }}
                        </div>
                        
                        <div class="border-top pt-3">
                            <h6>Or Create New Client</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.new_client_name.id_for_label }}">Name</label>
                                        {{ form.new_client_name }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.new_client_phone.id_for_label }}">Phone</label>
                                        {{ form.new_client_phone }}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.new_client_address.id_for_label }}">Address</label>
                                        {{ form.new_client_address }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.new_client_email.id_for_label }}">Email</label>
                                        {{ form.new_client_email }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Items -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Order Items</h5>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addOrderItem()">Add Item</button>
                    </div>
                    <div class="card-body">
                        <div id="order-items">
                            <!-- Order items will be added here dynamically -->
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6 offset-md-6">
                                <div class="d-flex justify-content-between">
                                    <strong>Total: </strong>
                                    <strong id="order-total">$0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Details -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Order Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.shipping_cost.id_for_label }}">Shipping Cost</label>
                                    {{ form.shipping_cost }}
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label for="{{ form.notes.id_for_label }}">Notes</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'order_list' %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let itemCounter = 0;

// Product data from Django
const products = [
    {% for product in products %}
    {
        id: {{ product.id }},
        name: "{{ product.name|escapejs }}",
        color: "{{ product.color|escapejs }}",
        price: {{ product.selling_price_per_piece }},
        stock: {{ product.pieces_left }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function addOrderItem() {
    const container = document.getElementById('order-items');
    
    // Build product options
    let productOptions = '<option value="">Select Product</option>';
    products.forEach(product => {
        const displayName = product.name + (product.color ? ` (${product.color})` : '') + ` - Stock: ${product.stock}`;
        productOptions += `<option value="${product.id}" data-price="${product.price}" data-stock="${product.stock}">${displayName}</option>`;
    });
    
    const itemHtml = `
        <div class="order-item row mb-3" id="item-${itemCounter}">
            <div class="col-md-4">
                <select name="product_id[]" class="form-control product-select" onchange="updatePrice(${itemCounter})" required>
                    ${productOptions}
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" name="quantity[]" class="form-control" placeholder="Qty" min="1" onchange="updateItemTotal(${itemCounter})" required>
            </div>
            <div class="col-md-3">
                <input type="number" name="price[]" class="form-control" placeholder="Price" step="0.01" min="0" onchange="updateItemTotal(${itemCounter})" required>
            </div>
            <div class="col-md-2">
                <div class="item-total font-weight-bold">$0.00</div>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeOrderItem(${itemCounter})">Ã—</button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', itemHtml);
    itemCounter++;
}

function removeOrderItem(id) {
    const item = document.getElementById(`item-${id}`);
    if (item) {
        item.remove();
        updateOrderTotal();
    }
}

function updatePrice(id) {
    const select = document.querySelector(`#item-${id} .product-select`);
    const priceInput = document.querySelector(`#item-${id} input[name="price[]"]`);
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption && selectedOption.dataset.price) {
        priceInput.value = selectedOption.dataset.price;
        updateItemTotal(id);
    }
}

function updateItemTotal(id) {
    const quantity = document.querySelector(`#item-${id} input[name="quantity[]"]`).value;
    const price = document.querySelector(`#item-${id} input[name="price[]"]`).value;
    const totalElement = document.querySelector(`#item-${id} .item-total`);
    
    if (quantity && price) {
        const total = parseFloat(quantity) * parseFloat(price);
        totalElement.textContent = `$${total.toFixed(2)}`;
    } else {
        totalElement.textContent = '$0.00';
    }
    
    updateOrderTotal();
}

function updateOrderTotal() {
    let total = 0;
    document.querySelectorAll('.order-item').forEach(item => {
        const quantity = item.querySelector('input[name="quantity[]"]').value;
        const price = item.querySelector('input[name="price[]"]').value;
        if (quantity && price) {
            total += parseFloat(quantity) * parseFloat(price);
        }
    });
    
    const shipping = document.getElementById('{{ form.shipping_cost.id_for_label }}').value || 0;
    total += parseFloat(shipping);
    
    document.getElementById('order-total').textContent = `$${total.toFixed(2)}`;
}

// Add first item on page load
addOrderItem();

// Update total when shipping cost changes
document.getElementById('{{ form.shipping_cost.id_for_label }}').addEventListener('input', updateOrderTotal);
</script>
{% endblock %}
